<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="video-stream.html">
<script src="https://static.opentok.com/v2/js/opentok.min.js"></script>

<!--
`smooth-opentok`
Opentok&#39;s API wrapped as a Polymer element for sane humans

@demo demo/index.html
-->

<dom-module id="smooth-opentok">
  <style>
    video-stream {
      width: 150px;
      height: 200px;
    }
  </style>
  <template>
    <template is="dom-repeat" items="{{streams}}">
      <video-stream
        data-stream-id$="[[item.id]]"
        stream="{{item}}"
        hero$="[[!index]]"
        on-request-fullscreen="_makeFullScreen">
      </video-stream>
    </template>
  </template>

  <script>
    Polymer({

      is: 'smooth-opentok',

      properties: {
        streams: {
          type: Array,
          value: function() {
            return []
          },
          notify: true
        },

        credentials: {
          type: Object,
          value: function() {
            return {
              api_key: 45990672,
              session_id: '1_MX40NTk5MDY3Mn5-MTUzNjE2MjE3MzA1Mn5lR1ZWRWJid0ZoVldDeStwYlNMMUVNeVd-fg',
              token: 'T1==cGFydG5lcl9pZD00NTk5MDY3MiZzaWc9NTk2OGRjYWY3ZTc0NmMyNjRmMjk4ZTU3ODUwZjdkNWFkNWU5ODg3NTpzZXNzaW9uX2lkPTFfTVg0ME5UazVNRFkzTW41LU1UVXpOakUyTWpFM016QTFNbjVsUjFaV1JXSmlkMFpvVmxkRGVTdHdZbE5NTVVWTmVWZC1mZyZjcmVhdGVfdGltZT0xNTM2MTYyMTczJm5vbmNlPTAuNzUxNDY3MTIxOTExNjI0OSZyb2xlPXB1Ymxpc2hlciZleHBpcmVfdGltZT0xNTM4NTgxMzczJmluaXRpYWxfbGF5b3V0X2NsYXNzX2xpc3Q9'
            }
          }
        }
      },

      ready: function() {
        window.smoothOpentok = this
      },

      attached: function() {
        OT.registerScreenSharingExtension(
          'chrome',
          'fjdpgnenpoklmkcobgbnfnelpafdjhpp',
          2
        )

        this.session = OT.initSession(this.credentials.api_key, this.credentials.session_id)

        this.session.on('streamCreated', e => {
          const subscriber = this.session.subscribe(e.stream, null, {
            insertDefaultUI: false
          }, this._handleRTCError.bind(this))

          subscriber.on('videoElementCreated', event => {
            this.push('streams', Object.assign(subscriber.stream, {
              element: event.element
            }))
          })
        })

        this.session.on('streamDestroyed', e => {
          const i = this.streams.findIndex(item => item.id === e.stream.id)
          this.splice('streams', i, 1)
        })

        this.session.on('streamPropertyChanged', e => {
          const i = this.streams.findIndex(item => item.id === e.stream.id)
          this.set(`streams.${i}.${e.changedProperty}`, e.newValue)
        })
      },

      startCall: function() {
        this.publisher = OT.initPublisher(null, {
          publishVideo: false,
          insertDefaultUI: false
        }, this._handleRTCError.bind(this))

        this.session.connect(this.credentials.token, err => {
          if (err) return this._handleRTCError(error)

          this.session.publish(this.publisher, this._handleRTCError.bind(this))
        })

        this.publisher.on('videoElementCreated', e => {
          this.publisher.on('streamCreated', () => {
            this.push('streams', Object.assign(this.publisher.stream, {
              element: e.element
            }))
          })
        })

        this.publisher.on('streamDestroyed', e => {
          this.set('streams', [])
        })
      },

      toggleVideo: function(flag) {
        this.publisher.publishVideo(flag)
      },

      stopCall: function() {
        this.session.disconnect()
      },

      startScreenshare: function() {
        // @TODO cleanup code style
        let ffWhitelistVersion; // = '36';

        OT.checkScreenSharingCapability(response => {
          if (!response.supported || response.extensionRegistered === false) {
            // @TODO Handle browser not supporting screen sharing.
          } else if (response.extensionInstalled === false
              && (response.extensionRequired || !ffWhitelistVersion)) {
                // @TODO Handle extension not installed.
          } else if (ffWhitelistVersion && navigator.userAgent.match(/Firefox/)
            && navigator.userAgent.match(/Firefox\/(\d+)/)[1] < ffWhitelistVersion) {
              // @TODO Handle FF <36
          } else {
            // Screen sharing is available. Publish the screen.
            // Create an element, but do not display it in the HTML DOM:
            this.screenSharingPublisher = OT.initPublisher(null, { insertDefaultUI: false, videoSource: 'screen' }, err => {
              if (err) return this._handleRTCError(err)

              this.session.publish(this.screenSharingPublisher, err => {
                if (err) return this._handleRTCError(err)
              })
            })

            this.screenSharingPublisher.on('videoElementCreated', e => {
              this.screenSharingPublisher.on('streamCreated', () => {
                this.push('streams', Object.assign(this.screenSharingPublisher.stream, {
                  element: e.element
                }))
              })
            })

            this.screenSharingPublisher.on('streamDestroyed', e => {
              const i = this.streams.findIndex(item => item.id === e.stream.id)
              this.splice('streams', i, 1)
            })
          }
        });
      },

      stopScreenshare: function() {
        this.session.unpublish(this.screenSharingPublisher)
      },

      _handleRTCError: function(e) {
        if (!e) return

        console.error(e)
      }
    });
  </script>
</dom-module>
