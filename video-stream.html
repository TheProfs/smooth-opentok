<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/av-icons.html">

<!--
`video-stream`
An individual video stream element

@demo demo/index.html
-->

<dom-module id="video-stream">
  <template>
    <style>
      :host {
        position: relative;
        display: inline-block;
        max-width: 100%;
        min-width: 150px;
        min-height: 120px;
        background: #111;
        text-align: center;
        overflow: visible;
      }

      [hidden] {
        display: none !important;
      }

      .resize-handle {
        position: absolute;
        width: 15px;
        height: 15px;
        bottom: 0;
        right: 0;
        background: #999;
        z-index: 99;
        cursor: nwse-resize;
      }

      .handle {
        position: relative;
        width: 100%;
        height: 100%;
        padding-top: 40px;
        height: calc(100% - 40px);
        cursor: move;
      }

      .top-controls {
        position: absolute;
        background: #009688;
        top: 0;
        height: 40px;
        width: 100%;
        text-align: left;
      }

      #audio-cover,
      #video {
        position: relative;
        width: 100%;
        height: 100%;
      }

      #audio-cover iron-icon {
        position: absolute;
        margin: auto;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        color: #009688;
      }

      #video video {
        width: 100%;
        height: 100%;
      }
    </style>

    <div id="resizeHandle" class="resize-handle"></div>
    <div id="handle" class="handle" draggable="true">
      <div class="top-controls">
        <paper-icon-button
          icon="aspect-ratio"
          on-tap="_requestPrincipal">
        </paper-icon-button>

        <paper-icon-button
          icon$="[[_computeMuteIcon(stream.hasAudio)]]"
          on-tap="_toggleAudio"
          hidden$="[[_shouldHideMuteButton(stream)]]">
        </paper-icon-button>

        <paper-icon-button
          icon$="[[_computeVideoIcon(stream.hasVideo)]]"
          on-tap="_toggleVideo"
          hidden$="[[_shouldHideVideoButton(stream)]]">
        </paper-icon-button>
      </div>

      <div id="audio-cover" hidden$="[[stream.hasVideo]]">
        <iron-icon icon$="[[_computeMuteIcon(stream.hasAudio)]]"></iron-icon>
      </div>

      <div
        id="video"
        hidden$="[[!stream.hasVideo]]"
        ondragstart="event.preventDefault();"
        draggable="true">
      </div>
    </div>
  </template>

  <script>
    Polymer({

      is: 'video-stream',

      properties: {
        stream: {
          type: Object
        },

        dragging: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        }
      },

      ready: function() {
        this._attachDragListeners()
        this._attachResizeListeners()
        this.init()
      },

      init: function() {
        Polymer.dom(this.$.video).appendChild(this.stream.element)
      },

      setDownPoint: function({ x, y }) {
        const bbox = this.getBoundingClientRect()
        this.set('dragDownPoint', { x: x - bbox.x , y: y - bbox.y })
      },

      reset: function() {
        this.removeAttribute('style')
      },

      resetPosition: function() {
        this.style.position = 'inline-block'
        this.style.left = `auto`
        this.style.top = `auto`
      },

      setPosition: function({ x, y }) {
        this.style.position = 'fixed'
        this.style.left = `${x - this.dragDownPoint.x}px`
        this.style.top = `${y - this.dragDownPoint.y}px`
      },

      _attachDragListeners: function() {
        this.$.handle.domHost = this

        this.addEventListener('dragstart', e => {
          const bbox = this.getBoundingClientRect()

          this.style.width = `${bbox.width}px`
          this.style.height = `${bbox.height}px`
        })

        this.addEventListener('drag', e => {
          this.set('dragging', true)
        })

        this.addEventListener('dragend', e => {
          this.set('dragging', false)
        })
      },

      _attachResizeListeners: function() {
        this.$.resizeHandle.addEventListener('mousedown', e => {
          const resizeHandleBBox = this.$.resizeHandle.getBoundingClientRect()

          this.set('resizeDownPoint', {
            x: resizeHandleBBox.x + resizeHandleBBox.width / 2,
            y: resizeHandleBBox.y + resizeHandleBBox.height / 2
          })

          this.isResizing = true
        })

        window.addEventListener('mouseup', e => {
          this.isResizing = false
        })

        window.addEventListener('mousemove', e => {
          if (!this.isResizing) return

          const bbox = this.getBoundingClientRect()

          const delta = {
            x: e.clientX - this.resizeDownPoint.x,
            y: e.clientY - this.resizeDownPoint.y
          }

          this.style.width = `${bbox.width + delta.x}px`
          this.style.height = `${bbox.height + delta.y}px`

          const resizeHandleBBox = this.$.resizeHandle.getBoundingClientRect()

          this.set('resizeDownPoint', {
            x: resizeHandleBBox.x + resizeHandleBBox.width / 2,
            y: resizeHandleBBox.y + resizeHandleBBox.height / 2
          })
        })
      },

      _requestPrincipal: function() {
        this.fire('request-principal')
      },

      _toggleAudio: function() {
        this.stream.publisher.publishAudio(!this.stream.hasAudio)
      },

      _toggleVideo: function() {
        this.stream.publisher.publishVideo(!this.stream.hasVideo)
      },

      _computeMuteIcon: function(hasAudio) {
        return hasAudio ? 'av:mic' : 'av:mic-off'
      },

      _computeVideoIcon: function(hasVideo) {
        return hasVideo ? 'av:videocam' : 'av:videocam-off'
      },

      _shouldHideMuteButton: function(stream) {
        return !stream.publisher || stream.videoType === 'screen'
      },

      _shouldHideVideoButton: function(stream) {
        return !stream.publisher || stream.videoType === 'screen'
      }
    })
  </script>
</dom-module>
